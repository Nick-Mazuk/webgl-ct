<html>
  <head>
    <title>WebGL-CT</title>
    <script type="text/javascript" src="glMatrix-0.9.5.min.js"></script>
  
    <script id="simple-fs" type="x-shader/x-fragment">
      precision mediump float;
      uniform float a; //for javascript simplicity
      uniform float b;
      uniform float c;
      
      varying vec2 vTextureCoord;
      uniform sampler2D uSampler;
      
      void main(void) {
        gl_FragColor = texture2D(uSampler, vTextureCoord);
      }

    </script>
    <script id="simulate-fs" type="x-shader/x-fragment">
      precision mediump float;
      uniform float a;
      uniform float b;
      uniform float c;
      
      varying vec2 vTextureCoord;
    
      uniform sampler2D uSampler;
      void simulate(void) {
        float angle = 3.14*(vTextureCoord.y-vTextureCoord.x*.4); //-x*.4 magically removes distortions
        mat2 RotationMatrix = mat2(cos(angle), -sin(angle),
                                   sin(angle),  cos(angle));
        vec2 unit = normalize(vec2(2.0*(vTextureCoord.x-0.5),-(a+b)));
        vec2 point = vec2(0,a);
        float value = 0.0;
        for(int i = 0; i < 1000; i++){
          point += unit*vec2(2.0/1000.0,2.0/1000.0);
          value += texture2D(uSampler, point * RotationMatrix/vec2(2.0,2.0)+vec2(.5,.5)).r;
        }
        value /= 1000.0;
        gl_FragColor.rbga = vec4(value,value,value,1.0);
      }
      
      void main(void) {
        simulate();
      }

    </script>
    
    <script id="recreate-fs" type="x-shader/x-fragment">
      precision mediump float;
      uniform float a;
      uniform float b;
      uniform float c;
      
      varying vec2 vTextureCoord;
    
      uniform sampler2D uSampler;
      float getValue(float amp, float ang, float temp){
        float angle = amp*cos(temp*3.14 + ang - 3.14/5.0)/2.0;
        float tmp  = 277.8*texture2D(uSampler, vec2(angle+0.5,temp)).r;
              tmp -= 112.6*texture2D(uSampler, vec2(angle+0.53,temp)).r;
              tmp -= 112.6*texture2D(uSampler, vec2(angle+0.47,temp)).r;
              tmp -= 12.51*texture2D(uSampler, vec2(angle+0.56,temp)).r;
              tmp -= 12.51*texture2D(uSampler, vec2(angle+0.44,temp)).r;
              tmp -= 4.503*texture2D(uSampler, vec2(angle+0.59,temp)).r;
              tmp -= 4.503*texture2D(uSampler, vec2(angle+0.41,temp)).r;
              tmp -= 3.127*texture2D(uSampler, vec2(angle+0.62,temp)).r;
              tmp -= 3.127*texture2D(uSampler, vec2(angle+0.38,temp)).r;
        return tmp;
      }
      void recreate(void) {
        vec2 pos = vTextureCoord * vec2(2,2) - vec2(1,1);
        pos = pos/(1.-pos.x*pos.x-pos.y*pos.y);
        float temp = length(pos)/a;
        float amplitude = temp/sqrt(temp*temp+1.0);
        float angle = atan(-pos.y,pos.x); //not sure why I needed to flip y here
        float value = 0.0;
        temp = 0.0;
        for(int i = 0; i < 1000; i++){
          temp += 1.0 / 1000.;
          value += getValue(amplitude,angle,temp);
        }
        value = value/5000.0 - 0.1;
        gl_FragColor.rbga = vec4(value,value,value,1.0);
      }
      
      void main(void) {
        recreate();
      }

    </script>
    
    <script id="shader-vs" type="x-shader/x-vertex">
      attribute vec3 aVertexPosition;
      
      varying vec2 vTextureCoord;
      
      void main(void) {
        gl_Position =  vec4(aVertexPosition, 1.0);
        vTextureCoord = (aVertexPosition.xy+vec2(1,1))/vec2(2,2);
      }
    </script>
  </head>
  <body onload="drawScene();">
    <canvas id="canvas" style="border: none;" width="1536" height="512"></canvas>
    <script src="test.js"></script>
  </body>
</html>
